name: Nightly Playwright E2E

on:
  workflow_dispatch:
    inputs:
      skip_pack_e2e:
        description: "Skip @pack tests"
        type: boolean
        default: false
      suite:
        description: "Suite to run"
        type: choice
        options:
          - smoke
          - regression
        default: regression
  schedule:
    - cron: "0 2 * * *" # 02:00 UTC nightly

concurrency:
  group: nightly-e2e-${{ github.ref_name }}
  cancel-in-progress: true

env:
  ACTIONS_STEP_DEBUG: true
  # Base URL precedence: PLAYWRIGHT_BASE_URL > E2E_BASE_URL > http://127.0.0.1:5173
  PLAYWRIGHT_BASE_URL: ${{ vars.PLAYWRIGHT_BASE_URL }}
  E2E_BASE_URL: ${{ vars.E2E_BASE_URL }}
  DEFAULT_BASE_URL: http://127.0.0.1:5173
  # API base expected for preview mode
  VITE_API_URL: http://localhost:3000/api

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: app
          POSTGRES_USER: app
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U app" --health-interval 10s --health-timeout 5s --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Early diagnostics
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p early-diagnostics
          {
            echo "== ENV ==";
            env | sort;
            echo;
            echo "== GIT ==";
            git status --porcelain || true;
            git log -1 --oneline || true;
            echo;
            echo "== Node ==";
            node -v || true;
            npm -v || true;
            echo;
            echo "== Directory tree (top-level) ==";
            ls -la || true;
            echo;
            echo "== Frontend Playwright config detect ==";
            if [ -f frontend/playwright.config.ts ]; then
              echo "Found frontend/playwright.config.ts";
            else
              echo "No Playwright config at frontend/playwright.config.ts";
            fi;
            echo;
            echo "== Enumerate tests ==";
            find frontend -maxdepth 3 -type f -name "*.spec.*" -print || true;
          } > early-diagnostics/meta.txt
          ls -laR > early-diagnostics/ls.txt

      - name: Upload early diagnostics (always)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: early-diagnostics
          path: early-diagnostics
          retention-days: 21

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          npm --prefix backend ci || npm --prefix backend install
          npm --prefix frontend ci || npm --prefix frontend install
          # Install Playwright browsers
          npx --yes playwright install --with-deps

      - name: Migrate and seed database
        shell: bash
        env:
          DATABASE_URL: postgresql://app:password@localhost:5432/app
        run: |
          set -euo pipefail
          if [ -d backend ]; then
            pushd backend >/dev/null
            npx --yes prisma migrate deploy || true
            if npx --yes prisma db seed --help >/dev/null 2>&1; then
              npx --yes prisma db seed || true
            fi
            popd >/dev/null
          fi

      - name: Run E2E
        shell: bash
        env:
          INPUT_SKIP_PACK_E2E: ${{ inputs.skip_pack_e2e }}
          INPUT_SUITE: ${{ inputs.suite }}
          DATABASE_URL: postgresql://app:password@localhost:5432/app
        run: |
          set -euo pipefail
          export SKIP_PACK_E2E="${INPUT_SKIP_PACK_E2E}"
          export SUITE="${INPUT_SUITE}"
          # Resolve Base URL precedence
          BASE_URL="${PLAYWRIGHT_BASE_URL:-}"
          if [ -z "${BASE_URL}" ]; then BASE_URL="${E2E_BASE_URL:-}"; fi
          if [ -z "${BASE_URL}" ]; then BASE_URL="${DEFAULT_BASE_URL}"; fi
          export PLAYWRIGHT_BASE_URL="$BASE_URL"
          echo "Using PLAYWRIGHT_BASE_URL=$PLAYWRIGHT_BASE_URL"
          bash scripts/ci-e2e.sh

      - name: Upload E2E logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs
          path: |
            backend.log
            frontend.log
          retention-days: 21

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report
          retention-days: 21
