// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & USERS
// ============================================================================

model User {
  id            String          @id @default(cuid())
  email         String          @unique
  passwordHash  String
  name          String?
  avatar        String?
  role          UserRole        @default(CUSTOMER)
  status        UserStatus      @default(ACTIVE)
  taxExempt     Boolean         @default(false)
  taxExemptId   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  designs       Design[]
  orders        Order[]
  stores        Store[]         @relation("StoreOwners")
  teams         Team[]          @relation("TeamMembers")
  notifications Notification[]
  apiKeys       ApiKey[]
  tenantUsers   TenantUser[]
  auditLogs     AuditLog[]
  proofRequests ProofApproval[] @relation("ProofRequestedBy")
  proofEvents   ProofApprovalEvent[]
  fileAssetsCreated FileAsset[]
  artworkAssets ArtworkAsset[]
  customizationsCreated Customization[]
  networkUserRoles NetworkUserRole[]
  fundraiserConsolidationRunsCreated FundraiserConsolidationRun[]
  productionBatchEventsActor ProductionBatchEvent[]
  productionAssignments ProductionAssignment[]

  @@index([email])
  @@index([role])
}

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
  STORE_OWNER
  PRODUCTION_MANAGER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  key       String   @unique
  name      String
  lastUsed  DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================================================
// STORES & TEAMS (Multi-tenant)
// ============================================================================

model Store {
  id            String        @id @default(cuid())
  name          String
  slug          String        @unique
  description   String?
  logo          String?
  theme         Json?
  domain        String?       @unique
  status        StoreStatus   @default(ACTIVE)
  type          StoreType     @default(RETAIL)
  owners        User[]        @relation("StoreOwners")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  tenantId      String?
  tenant        Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  products      Product[]
  productVariants ProductVariant[]
  productImages ProductImage[]
  orders        Order[]
  quotes        Quote[]
  quoteLineItems QuoteLineItem[]
  teams         Team[]
  paymentConfig PaymentConfig?
  storeSettings StoreSettings?
  customPages   CustomPage[]
  importJobs    ImportJob[]
  pricingRuleSets PricingRuleSet[]
  pricingRules  PricingRule[]
  fileAssets    FileAsset[]
  proofApprovals ProofApproval[]
  proofApprovalEvents ProofApprovalEvent[]
  storefronts   Storefront[]
  collections   Collection[]
  collectionProducts CollectionProduct[]
  pages         Page[]
  carts         Cart[]
  cartItems     CartItem[]
  checkoutSessions CheckoutSession[]
  teamStores    TeamStore[]
  rosters       Roster[]
  personalizationFields PersonalizationField[]
  teamStoreOrderMetas TeamStoreOrderMeta[]
  inventoryItems InventoryItem[]
  stockMovements StockMovement[]
  purchaseOrders PurchaseOrder[]
  purchaseOrderLines PurchaseOrderLine[]
  webhookEndpoints WebhookEndpoint[]
  webhookDeliveries WebhookDelivery[]
  // DecoNetwork connections
  decoConnections DecoNetworkConnection[]
  inventoryEvents InventoryEvent[]
  dnInventoryEventMaps DnInventoryEventMap[]
  supplierConnections SupplierConnection[]
  externalProductMaps ExternalProductMap[]
  externalVariantMaps ExternalVariantMap[]
  externalImageMaps ExternalImageMap[]
  supplierSyncRuns SupplierSyncRun[]
  supplierSyncRunErrors SupplierSyncRunError[]
  shippingRates ShippingRate[]
  taxRates TaxRate[]
  storeDomains StoreDomain[]
  onboardingStates OnboardingState[]
  storeBrandings StoreBranding[]
  themeConfigs ThemeConfig[]
  emailMessages EmailMessage[]
  documentTemplates DocumentTemplate[]
  generatedDocuments GeneratedDocument[]
  quotePublicTokens QuotePublicToken[]
  invoicePublicTokens InvoicePublicToken[]
  productCustomizationProfiles ProductCustomizationProfile[]
  personalizationSchemas PersonalizationSchema[]
  artworkCategories ArtworkCategory[]
  artworkAssets ArtworkAsset[]
  customizations Customization[]
  printPackages PrintPackage[]
  networkStores NetworkStore[]
  storeCatalogBindings StoreCatalogBinding[]
  routedOrdersFrom RoutedOrder[] @relation("RoutedOrderFromStore")
  routedOrdersTo RoutedOrder[] @relation("RoutedOrderToStore")
  fulfilledOrders Order[] @relation("OrderFulfillmentStore")
  royaltyLedgerFrom RoyaltyLedgerEntry[] @relation("RoyaltyFromStore")
  royaltyLedgerTo RoyaltyLedgerEntry[] @relation("RoyaltyToStore")
  fundraiserCampaigns FundraiserCampaign[]
  fundraiserMembers FundraiserCampaignMember[]
  fundraiserConsolidationRuns FundraiserConsolidationRun[]
  fundraiserPayoutLedgerEntries FundraiserPayoutLedgerEntry[]
  productionBatches ProductionBatch[] @relation("ProductionBatchStore")
  productionBatchesAsFulfillment ProductionBatch[] @relation("ProductionBatchFulfillmentStore")

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([status])
}

// ============================================================================
// TENANCY & RBAC
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  description String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users     TenantUser[]
  roles     Role[]
  auditLogs AuditLog[]
  stores    Store[]
  subscriptions TenantSubscription[]
  billingEvents BillingEvent[]
  billingInvoices BillingInvoice[]
  featureOverrides FeatureOverride[]
  onboardingStates OnboardingState[]
  emailProviderConfigs EmailProviderConfig[]
  emailMessages EmailMessage[]
  emailEvents EmailEvent[]
  quotePublicTokens QuotePublicToken[]
  invoicePublicTokens InvoicePublicToken[]
  networks Network[]
  fundraiserCampaigns FundraiserCampaign[]

  @@index([slug])
}

model Plan {
  id          String   @id @default(cuid())
  code        PlanCode @unique
  name        String
  priceCents  Int?
  interval    PlanInterval @default(MONTH)
  features    Json
  limits      Json
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions TenantSubscription[]

  @@index([active, code])
}

enum PlanCode {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum PlanInterval {
  MONTH
  YEAR
}

model TenantSubscription {
  id                   String   @id @default(cuid())
  tenantId             String
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planCode             PlanCode
  plan                 Plan     @relation(fields: [planCode], references: [code], onDelete: Restrict)
  status               SubscriptionStatus @default(TRIALING)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  provider             BillingProvider @default(MOCK)
  providerCustomerId   String?
  providerSubId        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([tenantId, status])
  @@index([planCode])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum BillingProvider {
  MOCK
  STRIPE
}

model BillingEvent {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  type      String
  payload   Json?
  createdAt DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([type])
}

model BillingInvoice {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  number      String
  status      BillingInvoiceStatus @default(DRAFT)
  amountCents Int
  currency    String   @default("USD")
  issuedAt    DateTime @default(now())
  paidAt      DateTime?
  providerRef String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, number])
  @@index([tenantId, issuedAt])
}

enum BillingInvoiceStatus {
  DRAFT
  PAID
  VOID
}

model StoreDomain {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  hostname          String   @unique
  status            DomainStatus @default(PENDING)
  verificationToken String
  verifiedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([storeId, status])
}

enum DomainStatus {
  PENDING
  ACTIVE
  DISABLED
}

model FeatureOverride {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key       String
  enabled   Boolean
  meta      Json?
  createdAt DateTime @default(now())

  @@unique([tenantId, key])
  @@index([tenantId])
}

model Network {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stores            NetworkStore[]
  userRoles         NetworkUserRole[]
  sharedCatalogItems SharedCatalogItem[]
  routingRules      FulfillmentRoutingRule[]
  routedOrders      RoutedOrder[]
  royaltyRules      RoyaltyRule[]
  royaltyLedger     RoyaltyLedgerEntry[]
  fundraiserCampaigns FundraiserCampaign[]
  productionBatches ProductionBatch[]

  @@index([tenantId])
  @@index([enabled])
}

enum NetworkStoreRole {
  OWNER
  HUB
  SPOKE
}

enum NetworkStoreStatus {
  ACTIVE
  SUSPENDED
}

model NetworkStore {
  id        String   @id @default(cuid())
  networkId String
  network   Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  role      NetworkStoreRole @default(SPOKE)
  status    NetworkStoreStatus @default(ACTIVE)
  createdAt DateTime @default(now())

  @@unique([networkId, storeId])
  @@index([storeId])
  @@index([networkId, role, status])
}

enum NetworkUserRoleType {
  NETWORK_ADMIN
  NETWORK_VIEWER
}

model NetworkUserRole {
  id        String   @id @default(cuid())
  networkId String
  network   Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      NetworkUserRoleType
  createdAt DateTime @default(now())

  @@unique([networkId, userId, role])
  @@index([userId])
}

enum SharedCatalogItemType {
  PRODUCT
  PRICING_RULE_SET
  ARTWORK_CATEGORY
  ARTWORK_ASSET
  THEME_TEMPLATE
}

model SharedCatalogItem {
  id          String   @id @default(cuid())
  networkId   String
  network     Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  type        SharedCatalogItemType
  sourceId    String
  version     Int      @default(1)
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  bindings    StoreCatalogBinding[]

  @@unique([networkId, type, sourceId])
  @@index([networkId, type])
}

enum StoreCatalogBindingStatus {
  APPLIED
  OVERRIDDEN
  DISABLED
}

model StoreCatalogBinding {
  id                 String   @id @default(cuid())
  storeId            String
  store              Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sharedCatalogItemId String
  sharedCatalogItem  SharedCatalogItem @relation(fields: [sharedCatalogItemId], references: [id], onDelete: Cascade)
  status             StoreCatalogBindingStatus @default(APPLIED)
  overrideData       Json?
  appliedVersion     Int      @default(0)
  appliedAt          DateTime?
  updatedAt          DateTime @updatedAt

  @@unique([storeId, sharedCatalogItemId])
  @@index([sharedCatalogItemId])
  @@index([storeId, status])
}

enum RoutingStrategy {
  MANUAL
  GEO
  CAPACITY
  PRIORITY
}

model FulfillmentRoutingRule {
  id        String   @id @default(cuid())
  networkId String
  network   Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  name      String
  enabled   Boolean  @default(true)
  strategy  RoutingStrategy @default(MANUAL)
  config    Json?
  createdAt DateTime @default(now())

  @@index([networkId, enabled])
}

enum RoutedOrderStatus {
  PROPOSED
  ACCEPTED
  IN_PRODUCTION
  SHIPPED
  COMPLETED
}

model RoutedOrder {
  id            String   @id @default(cuid())
  networkId     String
  network       Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  orderId       String   @unique
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromStoreId   String
  fromStore     Store    @relation("RoutedOrderFromStore", fields: [fromStoreId], references: [id], onDelete: Cascade)
  toStoreId     String
  toStore       Store    @relation("RoutedOrderToStore", fields: [toStoreId], references: [id], onDelete: Cascade)
  status        RoutedOrderStatus @default(PROPOSED)
  routingReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([networkId, status])
  @@index([fromStoreId])
  @@index([toStoreId])
}

enum RoyaltyBasis {
  REVENUE
  PROFIT
  DECORATION_ONLY
}

model RoyaltyRule {
  id          String   @id @default(cuid())
  networkId   String
  network     Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  name        String
  enabled     Boolean  @default(true)
  basis       RoyaltyBasis @default(REVENUE)
  ratePercent Float?
  flatCents   Int?
  appliesTo   Json?
  createdAt   DateTime @default(now())

  @@index([networkId, enabled])
}

enum RoyaltyLedgerStatus {
  ACCRUED
  INVOICED
  PAID
}

enum FundraiserCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  ARCHIVED
}

enum CampaignShippingMode {
  DIRECT
  CONSOLIDATED
}

enum FundraiserConsolidationStatus {
  CREATED
  LOCKED
  RELEASED
  COMPLETED
  CANCELED
}

enum FundraiserPayoutStatus {
  PENDING
  APPROVED
  PAID
  VOID
}

enum FundraiserPayoutDirection {
  CREDIT
  DEBIT
}

enum ProductionBatchSourceType {
  ORDER
  BULK_ORDER
}

enum ProductionBatchMethod {
  DTF
  EMBROIDERY
  SCREEN
  OTHER
}

enum ProductionBatchStage {
  ART
  APPROVED
  PRINT
  CURE
  PACK
  SHIP
  COMPLETE
  HOLD
  CANCELLED
}

enum ProductionBatchPriority {
  LOW
  NORMAL
  HIGH
  RUSH
}

enum ProductionBatchEventType {
  CREATED
  STAGE_CHANGED
  ASSIGNED
  UNASSIGNED
  NOTE
  EXPORT
  TICKET_PRINTED
  SHIPPED
  COMPLETED
  HOLD
  CANCELLED
}

enum ProductionAssignmentRole {
  OPERATOR
  LEAD
}

model ProductionBatch {
  id                 String                  @id @default(cuid())
  storeId            String
  store              Store                   @relation("ProductionBatchStore", fields: [storeId], references: [id], onDelete: Cascade)
  networkId          String?
  network            Network?                @relation(fields: [networkId], references: [id], onDelete: SetNull)
  fulfillmentStoreId String?
  fulfillmentStore   Store?                  @relation("ProductionBatchFulfillmentStore", fields: [fulfillmentStoreId], references: [id], onDelete: SetNull)
  sourceType         ProductionBatchSourceType
  sourceId           String
  method             ProductionBatchMethod   @default(DTF)
  stage              ProductionBatchStage    @default(ART)
  priority           ProductionBatchPriority @default(NORMAL)
  dueAt              DateTime?
  notes              String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  items              ProductionBatchItem[]
  events             ProductionBatchEvent[]
  assignments        ProductionAssignment[]
  scanTokens         ProductionScanToken[]

  @@index([storeId])
  @@index([networkId])
  @@index([fulfillmentStoreId])
  @@index([sourceType, sourceId])
  @@index([stage])
  @@index([method])
  @@index([dueAt])
}

model ProductionBatchItem {
  id                     String                      @id @default(cuid())
  batchId                String
  batch                  ProductionBatch             @relation(fields: [batchId], references: [id], onDelete: Cascade)
  orderId                String?
  order                  Order?                      @relation(fields: [orderId], references: [id], onDelete: SetNull)
  bulkOrderId            String?
  bulkOrder              FundraiserConsolidationRun? @relation(fields: [bulkOrderId], references: [id], onDelete: SetNull)
  productId              String
  product                Product                     @relation(fields: [productId], references: [id], onDelete: Restrict)
  variantId              String
  variant                ProductVariant              @relation(fields: [variantId], references: [id], onDelete: Restrict)
  designId               String?
  design                 Design?                     @relation(fields: [designId], references: [id], onDelete: SetNull)
  location               String
  qty                    Int
  personalizationSummary Json?
  assetRef               Json?
  createdAt              DateTime                    @default(now())

  @@index([batchId])
  @@index([orderId])
  @@index([bulkOrderId])
  @@index([productId])
  @@index([variantId])
  @@index([designId])
}

model ProductionBatchEvent {
  id          String                   @id @default(cuid())
  batchId     String
  batch       ProductionBatch          @relation(fields: [batchId], references: [id], onDelete: Cascade)
  type        ProductionBatchEventType
  fromStage   ProductionBatchStage?
  toStage     ProductionBatchStage?
  actorUserId String?
  actorUser   User?                    @relation(fields: [actorUserId], references: [id], onDelete: SetNull)
  meta        Json?
  createdAt   DateTime                 @default(now())

  @@index([batchId])
  @@index([type])
  @@index([createdAt])
}

model ProductionAssignment {
  id         String                   @id @default(cuid())
  batchId    String
  batch      ProductionBatch          @relation(fields: [batchId], references: [id], onDelete: Cascade)
  userId     String
  user       User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       ProductionAssignmentRole @default(OPERATOR)
  assignedAt DateTime                 @default(now())
  releasedAt DateTime?

  @@index([batchId])
  @@index([userId])
  @@index([releasedAt])
}

model ProductionScanToken {
  id        String          @id @default(cuid())
  batchId   String
  batch     ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  token     String          @unique
  expiresAt DateTime?
  createdAt DateTime        @default(now())

  @@index([batchId])
}

model FundraiserCampaign {
  id                      String                   @id @default(cuid())
  tenantId                String
  tenant                  Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  storeId                 String
  store                   Store                    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  networkId               String?
  network                 Network?                 @relation(fields: [networkId], references: [id], onDelete: SetNull)
  slug                    String
  name                    String
  description             String?
  status                  FundraiserCampaignStatus @default(DRAFT)
  startsAt                DateTime?
  endsAt                  DateTime?
  fundraisingGoalCents    Int?
  defaultFundraiserPercent Float?
  shippingMode            CampaignShippingMode     @default(DIRECT)
  allowSplitShip          Boolean                  @default(true)
  metadata                Json?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt

  productOverrides        FundraiserCampaignProduct[]
  teamStoreLinks          FundraiserCampaignTeamStore[]
  members                 FundraiserCampaignMember[]
  carts                   Cart[]                   @relation("CartFundraiserCampaign")
  orderItems              CartItem[]
  orders                  Order[]                  @relation("OrderFundraiserCampaign")
  consolidationRuns       FundraiserConsolidationRun[]
  payoutLedgerEntries     FundraiserPayoutLedgerEntry[]

  @@unique([storeId, slug])
  @@index([tenantId])
  @@index([storeId])
  @@index([networkId])
  @@index([status])
}

model FundraiserCampaignProduct {
  id                       String             @id @default(cuid())
  campaignId               String
  campaign                 FundraiserCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  productId                String
  product                  Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  overridePrice            Float?
  overrideFundraiserPercent Float?
  active                   Boolean            @default(true)
  metadata                 Json?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  @@unique([campaignId, productId])
  @@index([campaignId])
  @@index([productId])
}

model FundraiserCampaignTeamStore {
  id         String             @id @default(cuid())
  campaignId String
  campaign   FundraiserCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  teamStoreId String
  teamStore  TeamStore          @relation(fields: [teamStoreId], references: [id], onDelete: Cascade)
  createdAt  DateTime           @default(now())

  @@unique([campaignId, teamStoreId])
  @@index([campaignId])
  @@index([teamStoreId])
}

model FundraiserCampaignMember {
  id            String             @id @default(cuid())
  campaignId    String
  campaign      FundraiserCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  storeId       String
  store         Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  teamStoreId   String?
  teamStore     TeamStore?         @relation(fields: [teamStoreId], references: [id], onDelete: SetNull)
  rosterEntryId String?
  rosterEntry   Roster?            @relation(fields: [rosterEntryId], references: [id], onDelete: SetNull)
  displayName   String
  publicCode    String?
  isActive      Boolean            @default(true)
  goalCents     Int?
  metadata      Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  carts         Cart[]
  cartItems     CartItem[]
  orders        Order[]
  payoutLedgerEntries FundraiserPayoutLedgerEntry[]

  @@unique([campaignId, publicCode])
  @@unique([campaignId, rosterEntryId])
  @@index([campaignId])
  @@index([storeId])
  @@index([teamStoreId])
  @@index([rosterEntryId])
  @@index([isActive])
}

model FundraiserConsolidationRun {
  id             String                        @id @default(cuid())
  campaignId     String
  campaign       FundraiserCampaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  storeId        String
  store          Store                         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  status         FundraiserConsolidationStatus @default(CREATED)
  idempotencyKey String?                       @unique
  createdById    String?
  createdBy      User?                         @relation(fields: [createdById], references: [id], onDelete: SetNull)
  metadata       Json?
  createdAt      DateTime                      @default(now())
  updatedAt      DateTime                      @updatedAt

  lines          FundraiserConsolidationOrderLine[]
  productionBatchItems ProductionBatchItem[]

  @@index([campaignId])
  @@index([storeId])
  @@index([status])
}

model FundraiserConsolidationOrderLine {
  id             String                   @id @default(cuid())
  runId          String
  run            FundraiserConsolidationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  orderId        String
  order          Order                    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shippingMode   CampaignShippingMode
  splitGroup     String?
  status         String                   @default("PENDING")
  metadata       Json?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  @@unique([runId, orderId])
  @@unique([orderId])
  @@index([runId])
  @@index([orderId])
  @@index([status])
}

model FundraiserPayoutLedgerEntry {
  id             String                   @id @default(cuid())
  campaignId     String
  campaign       FundraiserCampaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  storeId        String
  store          Store                    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orderId        String?
  order          Order?                   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  memberId       String?
  member         FundraiserCampaignMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)
  direction      FundraiserPayoutDirection @default(CREDIT)
  amountCents    Int
  currency       String                   @default("USD")
  kind           String
  status         FundraiserPayoutStatus   @default(PENDING)
  idempotencyKey String?                  @unique
  notes          String?
  metadata       Json?
  approvedAt     DateTime?
  paidAt         DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  @@index([campaignId])
  @@index([storeId])
  @@index([orderId])
  @@index([memberId])
  @@index([status])
  @@index([kind])
}

model RoyaltyLedgerEntry {
  id           String   @id @default(cuid())
  networkId    String
  network      Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)
  orderId      String
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromStoreId  String
  fromStore    Store    @relation("RoyaltyFromStore", fields: [fromStoreId], references: [id], onDelete: Cascade)
  toStoreId    String
  toStore      Store    @relation("RoyaltyToStore", fields: [toStoreId], references: [id], onDelete: Cascade)
  revenueCents Int
  costCents    Int
  royaltyCents Int
  currency     String   @default("USD")
  status       RoyaltyLedgerStatus @default(ACCRUED)
  createdAt    DateTime @default(now())

  @@index([networkId, createdAt])
  @@index([orderId])
  @@index([fromStoreId])
  @@index([toStoreId])
}

model TenantUser {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  roles  TenantUserRole[]

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

model TenantUserRole {
  id        String   @id @default(cuid())
  tenantUserId String
  roleId    String
  assignedAt DateTime @default(now())

  tenantUser TenantUser @relation(fields: [tenantUserId], references: [id], onDelete: Cascade)
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([tenantUserId, roleId])
  @@index([roleId])
  @@index([tenantUserId])
}

model Role {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  description String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  users TenantUserRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())

  roles RolePermission[]

  @@unique([name])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  grantedAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model AuditLog {
  id           String   @id @default(cuid())
  tenantId     String
  userId       String?
  actorUserId  String?
  actorType    String?
  action       String
  resourceType String?
  resourceId   String?
  entityType   String?
  entityId     String?
  payload      Json?
  meta         Json?
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
}

enum StoreStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum StoreType {
  RETAIL
  FUNDRAISER
  COMPANY
  NONPROFIT
}

model Team {
  id        String   @id @default(cuid())
  name      String
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  members   User[]   @relation("TeamMembers")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, name])
  @@index([storeId])
}

model StoreSettings {
  id                String   @id @default(cuid())
  storeId           String   @unique
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  taxRate           Float    @default(0)
  shippingFlatRate  Float    @default(0)
  enableCOD         Boolean  @default(false)
  enablePayPal      Boolean  @default(false)
  stripeAccountId   String?
  autoApproveOrders Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([storeId])
}

model CustomPage {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  title     String
  slug      String
  content   String   @db.Text
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, slug])
  @@index([storeId])
}

// ============================================================================
// PRODUCTS & VARIANTS (Base + Vendor)
// ============================================================================

model Product {

  id             String          @id @default(cuid())
  externalId   String?
  connectionId String?
  storeId        String
  store          Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name           String
  description    String?         @db.Text
  slug           String
  category       String?
  tags           String[]
  active         Boolean         @default(true)
  basePrice      Float           @default(0)
  status         ProductStatus   @default(DRAFT)
  type           ProductType     @default(BLANK)
  vendorId       String?
  vendor         Vendor?         @relation(fields: [vendorId], references: [id])
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  variants       ProductVariant[]
  images         ProductImage[]
  inventoryEvents InventoryEvent[]
  decorationAreas DecorationArea[]
  cartItems      CartItem[]
  collectionProducts CollectionProduct[]
  orderItems     OrderItem[]
  pricingRules   PricingRule[]
  quoteLineItems QuoteLineItem[]
  mockupTemplate MockupTemplate?
  customizationProfile ProductCustomizationProfile?
  personalizationSchemas PersonalizationSchema[]
  customizations Customization[]
  externalProductMaps ExternalProductMap[]
  fundraiserCampaignProducts FundraiserCampaignProduct[]
  productionBatchItems ProductionBatchItem[]
  // DecoNetwork mapping
  dnProductMaps DnProductMap[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([vendorId])
  @@index([status])

  @@unique([connectionId, externalId])

}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ProductType {
  BLANK
  DESIGN
  CUSTOM
}

model ProductVariant {
  id              String   @id @default(cuid())
  productId       String
  storeId         String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name            String   // e.g., "Red - Small"
  sku             String   @unique
  size            String?
  color           String?
  externalId      String?
  brand           String?
  weight          Float?
  cost            Float    @default(0)
  price           Float    @default(0)
  inventoryQty    Int      @default(0)
  supplierInventoryQty Int?
  supplierCost    Float    @default(0)
  inventoryCount  Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  cartItems       CartItem[]
  orderItems      OrderItem[]
  mockups         Mockup[]
  inventoryEvents InventoryEvent[]
  // DecoNetwork mapping
  dnVariantMaps DnVariantMap[]
  dnInventoryMaps DnInventoryMap[]
  vendorVariants  VendorProductVariant[]
  quoteLineItems  QuoteLineItem[] @relation("QuoteLineItemProductVariant")
  quoteLineItemsByVariant QuoteLineItem[] @relation("QuoteLineItemVariant")
  inventoryItems  InventoryItem[]
  stockMovements  StockMovement[]
  purchaseOrderLines PurchaseOrderLine[]
  externalVariantMaps ExternalVariantMap[]
  customizations Customization[]
  productionBatchItems ProductionBatchItem[]

  @@unique([productId, sku])
  @@index([storeId])
  @@index([productId])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  storeId   String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  url       String
  path      String?
  color     String?
  sortOrder Int      @default(0)
  altText   String?
  position  Int      @default(0)
  createdAt DateTime @default(now())
  externalImageMaps ExternalImageMap[]

  @@index([storeId])
  @@index([productId])
}

// ============================================================================
// DECORATION & DESIGN ZONES
// ============================================================================

model DecorationArea {
  id              String    @id @default(cuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  name            String    // e.g., "Front Left Chest"
  printMethod     PrintMethod
  maxWidth        Float
  maxHeight       Float
  offsetX         Float
  offsetY         Float
  rotationAngle   Float     @default(0)
  costPerSquareIn Float     @default(0)
  maxColorCount   Int?
  stitchCostPer1k Float     @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  designs         Design[]

  @@index([productId])
}

enum PrintMethod {
  SCREEN_PRINT
  EMBROIDERY
  DTG
  HEAT_TRANSFER
  SUBLIMATION
  DIRECT_EMBROIDERY
}

// ============================================================================
// VENDORS & SUPPLIER CATALOG
// ============================================================================

model Vendor {
  id              String    @id @default(cuid())
  name            String    @unique
  email           String
  apiKey          String?   @unique
  status          VendorStatus @default(ACTIVE)
  connectorType   String    @default("csv")
  lastSyncAt      DateTime?
  lastSyncStatus  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  products        Product[]
  vendorProducts  VendorProduct[]
  syncJobs        VendorSyncJob[]
  importJobs      ImportJob[]

  @@index([name])
  @@index([status])
}

enum VendorStatus {
  ACTIVE
  INACTIVE
  PAUSED
  SYNCING
}

model VendorProduct {
  id              String    @id @default(cuid())
  vendorId        String
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  externalId      String    // Vendor's internal ID
  name            String
  description     String?   @db.Text
  basePrice       Float
  brand           String?
  category        String?
  imageUrl        String?
  lastSyncedAt    DateTime  @default(now())
  syncData        Json?     // Raw vendor data
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  variants        VendorProductVariant[]

  @@unique([vendorId, externalId])
  @@index([vendorId])
}

model VendorProductVariant {
  id              String   @id @default(cuid())
  vendorProductId String
  vendorProduct   VendorProduct @relation(fields: [vendorProductId], references: [id], onDelete: Cascade)
  productVariantId String?
  productVariant  ProductVariant? @relation(fields: [productVariantId], references: [id])
  externalId      String
  size            String?
  color           String?
  sku             String?
  price           Float
  inventory       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([vendorProductId, externalId])
  @@index([vendorProductId])
  @@index([productVariantId])
}

model VendorSyncJob {
  id        String   @id @default(cuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  type      String   // "products", "inventory", "pricing"
  status    JobStatus @default(PENDING)
  error     String?
  startedAt DateTime?
  endedAt   DateTime?
  createdAt DateTime @default(now())

  @@index([vendorId])
  @@index([status])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// DESIGNS
// ============================================================================

model Design {
  id                  String     @id @default(cuid())
  userId              String
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId           String?
  decorationAreaId    String?
  decorationArea      DecorationArea? @relation(fields: [decorationAreaId], references: [id])
  name                String
  description         String?
  content             Json       // Canvas state: layers, text, images, etc.
  exportedImageUrl    String?    // PNG export URL
  mockupPreviewUrl    String? // New field added
  pricingSnapshot     Json?    // New field added
  exportAssets        Json?    // New field added
  vectorUrl           String?    // SVG export URL
  metadata            Json?
  status              DesignStatus @default(DRAFT)
  isPublic            Boolean    @default(false)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  assets              DesignAsset[]
  fileAssets          FileAsset[]
  mockups             Mockup[]
  proofApprovals      ProofApproval[]
  cartItems           CartItem[]
  orderItems          OrderItem[]
  customizations      Customization[]
  productionBatchItems ProductionBatchItem[]

  @@index([userId])
  @@index([status])
}

enum DesignStatus {
  DRAFT
  EXPORTED
  IN_PRODUCTION
  ARCHIVED
}

model DesignAsset {
  id        String   @id @default(cuid())
  designId  String
  design    Design   @relation(fields: [designId], references: [id], onDelete: Cascade)
  type      AssetType
  url       String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([designId])
}

model FileAsset {
  id              String        @id @default(cuid())
  storeId         String
  store           Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  designId        String?
  design          Design?       @relation(fields: [designId], references: [id], onDelete: SetNull)
  orderId         String?
  order           Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)
  productionJobId String?
  productionJob   ProductionJob? @relation(fields: [productionJobId], references: [id], onDelete: SetNull)
  kind            FileAssetKind
  fileName        String
  mimeType        String?
  url             String
  sizeBytes       Int?
  metadata        Json?
  createdById     String?
  createdBy       User?         @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt       DateTime      @default(now())
  supplierSyncRuns SupplierSyncRun[] @relation("SupplierSyncRunLogFile")
  externalImageMaps ExternalImageMap[]
  generatedDocuments GeneratedDocument[]
  brandingLogos StoreBranding[]
  artworkAssets ArtworkAsset[]
  customizationsPreview Customization[] @relation("CustomizationPreviewFile")
  printPackages PrintPackage[]

  @@index([storeId])
  @@index([designId])
  @@index([orderId])
  @@index([productionJobId])
  @@index([kind])
}

enum FileAssetKind {
  DESIGN_UPLOAD
  MOCKUP_RENDER
  EXPORT_IMAGE
  EXPORT_VECTOR
  CUSTOMIZER_UPLOAD
  CUSTOMIZER_PREVIEW
  PROOF_PDF
  WORK_ORDER_PDF
  PRINT_PACKAGE_ZIP
  QR_CODE
  QUOTE_PDF
  INVOICE_PDF
  SUPPLIER_IMAGE
  SUPPLIER_SYNC_LOG
}

model ProductCustomizationProfile {
  id            String   @id @default(cuid())
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId     String   @unique
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  enabled       Boolean  @default(true)
  locations     Json
  rules         Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  personalizationSchemas PersonalizationSchema[]
  artworkCategories ArtworkCategory[]
  customizations Customization[]

  @@index([storeId])
  @@index([enabled])
}

model PersonalizationSchema {
  id         String   @id @default(cuid())
  storeId    String
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId  String?
  product    Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  profileId  String?
  profile    ProductCustomizationProfile? @relation(fields: [profileId], references: [id], onDelete: Cascade)
  key        String
  label      String
  type       String
  required   Boolean  @default(false)
  minLength  Int?
  maxLength  Int?
  options    Json?
  pricing    Json?
  validation Json?
  sortOrder  Int      @default(0)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([storeId])
  @@index([productId])
  @@index([profileId])
  @@index([active])
  @@unique([profileId, key])
}

model ArtworkCategory {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  profileId String?
  profile   ProductCustomizationProfile? @relation(fields: [profileId], references: [id], onDelete: Cascade)
  name      String
  slug      String
  sortOrder Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assets ArtworkAsset[]

  @@index([storeId])
  @@index([profileId])
  @@unique([storeId, slug])
}

model ArtworkAsset {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    ArtworkCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  fileId      String
  file        FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  name        String
  tags        String[]
  status      ArtworkAssetStatus @default(ACTIVE)
  isPublic    Boolean  @default(true)
  metadata    Json?
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customizations Customization[] @relation("CustomizationArtworkAsset")

  @@index([storeId])
  @@index([categoryId])
  @@index([fileId])
  @@index([status])
}

enum ArtworkAssetStatus {
  ACTIVE
  ARCHIVED
}

model Customization {
  id             String   @id @default(cuid())
  storeId        String
  store          Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId      String?
  variant        ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  profileId      String?
  profile        ProductCustomizationProfile? @relation(fields: [profileId], references: [id], onDelete: SetNull)
  designId       String?
  design         Design?  @relation(fields: [designId], references: [id], onDelete: SetNull)
  artworkAssetId String?
  artworkAsset   ArtworkAsset? @relation("CustomizationArtworkAsset", fields: [artworkAssetId], references: [id], onDelete: SetNull)
  previewFileId  String?
  previewFile    FileAsset? @relation("CustomizationPreviewFile", fields: [previewFileId], references: [id], onDelete: SetNull)
  payload        Json
  pricingSnapshot Json?
  status         CustomizationStatus @default(DRAFT)
  createdById    String?
  createdBy      User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  printPackages PrintPackage[]

  @@index([storeId])
  @@index([productId])
  @@index([variantId])
  @@index([profileId])
  @@index([designId])
  @@index([status])
}

enum CustomizationStatus {
  DRAFT
  IN_CART
  ORDERED
  PROOF_PENDING
  APPROVED
  REJECTED
  PACKAGED
}

model OnboardingState {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  storeId     String?
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: SetNull)
  step        Int      @default(1)
  data        Json?
  completed   Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, storeId])
  @@index([tenantId, completed])
}

model StoreBranding {
  id            String   @id @default(cuid())
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  logoFileId    String?
  logoFile      FileAsset? @relation(fields: [logoFileId], references: [id], onDelete: SetNull)
  primaryColor  String   @default("#2563EB")
  secondaryColor String  @default("#0F172A")
  fontPreset    String   @default("INTER")
  companyName   String?
  supportEmail  String?
  footerLinks   Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([storeId])
  @@index([storeId])
}

model ThemeConfig {
  id           String   @id @default(cuid())
  storeId      String
  store        Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storefrontId String?
  storefront   Storefront? @relation(fields: [storefrontId], references: [id], onDelete: SetNull)
  config       Json
  version      Int      @default(1)
  publishedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([storeId, publishedAt])
  @@index([storefrontId])
}

model EmailProviderConfig {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider        EmailProviderType @default(MOCK)
  configEncrypted String?
  fromName        String
  fromEmail       String
  replyTo         String?
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId])
  @@index([tenantId, provider, enabled])
}

enum EmailProviderType {
  MOCK
  SMTP
  SENDGRID
}

model EmailMessage {
  id                String   @id @default(cuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  storeId           String?
  store             Store?   @relation(fields: [storeId], references: [id], onDelete: SetNull)
  type              EmailMessageType
  toEmail           String
  subject           String
  bodyText          String?
  bodyHtml          String?
  status            EmailMessageStatus @default(QUEUED)
  providerMessageId String?
  error             String?
  meta              Json?
  createdAt         DateTime @default(now())
  sentAt            DateTime?

  events            EmailEvent[]

  @@index([tenantId, createdAt])
  @@index([storeId, createdAt])
  @@index([status, type])
}

enum EmailMessageType {
  PROOF_REQUEST
  QUOTE_SENT
  ORDER_CONFIRMATION
  STATUS_UPDATE
}

enum EmailMessageStatus {
  QUEUED
  SENT
  FAILED
}

model EmailEvent {
  id             String   @id @default(cuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  emailMessageId String
  emailMessage   EmailMessage @relation(fields: [emailMessageId], references: [id], onDelete: Cascade)
  type           EmailEventType
  meta           Json?
  createdAt      DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([emailMessageId])
}

enum EmailEventType {
  QUEUED
  SENT
  FAILED
  OPEN
  CLICK
}

model DocumentTemplate {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  type      DocumentType
  name      String
  active    Boolean  @default(true)
  template  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, type, name])
  @@index([storeId, type, active])
}

enum DocumentType {
  QUOTE
  INVOICE
  PROOF
  WORK_ORDER
}

model GeneratedDocument {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  type      DocumentType
  refType   DocumentRefType
  refId     String
  fileId    String
  file      FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([storeId, type, createdAt])
  @@index([refType, refId])
  @@index([fileId])
}

enum DocumentRefType {
  QUOTE
  ORDER
  PROOF_REQUEST
  PRODUCTION_JOB
}

model QuotePublicToken {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  storeId    String
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  quoteId    String
  quote      Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  tokenHash  String   @unique
  expiresAt  DateTime?
  createdAt  DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([storeId, quoteId])
}

model InvoicePublicToken {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  storeId    String
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tokenHash  String   @unique
  expiresAt  DateTime?
  createdAt  DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([storeId, orderId])
}

enum AssetType {
  UPLOADED_IMAGE
  CLIPART
  TEXT
  VECTOR
}

enum SupplierName {
  SANMAR
  SSACTIVEWEAR
  ALPHABRODER
  MOCK
}

enum SupplierAuthType {
  API_KEY
  OAUTH2
  BASIC
  MOCK
}

enum SupplierSyncStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum SupplierSyncErrorScope {
  AUTH
  FETCH
  TRANSFORM
  DOWNLOAD
  DB
}

model SupplierConnection {
  id                   String           @id @default(cuid())
  storeId              String
  store                Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplier             SupplierName
  name                 String
  baseUrl              String?
  authType             SupplierAuthType
  credentialsEncrypted String           @db.Text
  enabled              Boolean          @default(true)
  syncEnabled          Boolean          @default(false)
  syncIntervalMinutes  Int              @default(1440)
  syncNextAt           DateTime?
  syncLastAttemptAt    DateTime?
  lastSyncAt           DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  externalProductMaps  ExternalProductMap[]
  externalVariantMaps  ExternalVariantMap[]
  externalImageMaps    ExternalImageMap[]
  syncRuns             SupplierSyncRun[]

  @@index([storeId])
  @@index([supplier])
  @@index([enabled])
  @@index([syncEnabled])
  @@index([syncNextAt])
}

model ExternalProductMap {
  id                   String            @id @default(cuid())
  storeId              String
  store                Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplierConnectionId String
  supplierConnection   SupplierConnection @relation(fields: [supplierConnectionId], references: [id], onDelete: Cascade)
  externalProductId    String
  productId            String
  product              Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  externalMeta         Json?
  createdAt            DateTime          @default(now())

  @@unique([supplierConnectionId, externalProductId])
  @@index([storeId])
  @@index([productId])
}

model ExternalVariantMap {
  id                   String            @id @default(cuid())
  storeId              String
  store                Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplierConnectionId String
  supplierConnection   SupplierConnection @relation(fields: [supplierConnectionId], references: [id], onDelete: Cascade)
  externalVariantId    String
  variantId            String
  variant              ProductVariant    @relation(fields: [variantId], references: [id], onDelete: Cascade)
  externalMeta         Json?
  createdAt            DateTime          @default(now())

  @@unique([supplierConnectionId, externalVariantId])
  @@index([storeId])
  @@index([variantId])
}

model ExternalImageMap {
  id                   String            @id @default(cuid())
  storeId              String
  store                Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplierConnectionId String
  supplierConnection   SupplierConnection @relation(fields: [supplierConnectionId], references: [id], onDelete: Cascade)
  externalImageId      String
  fileId               String?
  file                 FileAsset?        @relation(fields: [fileId], references: [id], onDelete: SetNull)
  productImageId       String
  productImage         ProductImage      @relation(fields: [productImageId], references: [id], onDelete: Cascade)
  externalMeta         Json?
  createdAt            DateTime          @default(now())

  @@unique([supplierConnectionId, externalImageId])
  @@index([storeId])
  @@index([fileId])
  @@index([productImageId])
}

model SupplierSyncRun {
  id                   String            @id @default(cuid())
  storeId              String
  store                Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplierConnectionId String
  supplierConnection   SupplierConnection @relation(fields: [supplierConnectionId], references: [id], onDelete: Cascade)
  status               SupplierSyncStatus @default(QUEUED)
  startedAt            DateTime?
  finishedAt           DateTime?
  durationMs           Int?
  attempts             Int               @default(0)
  counts               Json?
  errorSummary         String?
  logFileId            String?
  logFile              FileAsset?        @relation("SupplierSyncRunLogFile", fields: [logFileId], references: [id], onDelete: SetNull)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  errors               SupplierSyncRunError[]

  @@index([storeId])
  @@index([supplierConnectionId])
  @@index([status])
}

model SupplierSyncRunError {
  id          String                 @id @default(cuid())
  storeId     String
  store       Store                  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  syncRunId   String
  syncRun     SupplierSyncRun        @relation(fields: [syncRunId], references: [id], onDelete: Cascade)
  scope       SupplierSyncErrorScope
  message     String                 @db.Text
  meta        Json?
  createdAt   DateTime               @default(now())

  @@index([storeId])
  @@index([syncRunId])
  @@index([scope])
}

// ============================================================================
// MOCKUPS
// ============================================================================

model MockupTemplate {
  id            String   @id @default(cuid())
  productId     String   @unique
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  baseImageUrl  String
  maskUrl       String?
  perspectivePoints Json? // Corner points for perspective warp
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([productId])
}

model Mockup {
  id                String   @id @default(cuid())
  designId          String
  design            Design   @relation(fields: [designId], references: [id], onDelete: Cascade)
  productVariantId  String
  productVariant    ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  imageUrl          String
  thumbnailUrl      String?
  status            MockupStatus @default(PENDING)
  error             String?
  generatedAt       DateTime?
  expiresAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  proofApprovals    ProofApproval[]

  @@index([designId])
  @@index([productVariantId])
  @@index([status])
}

enum MockupStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

// ============================================================================
// PRICING
// ============================================================================

model PricingRule {
  id                String   @id @default(cuid())
  storeId           String
  productId         String
  ruleSetId         String?
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  ruleSet           PricingRuleSet? @relation(fields: [ruleSetId], references: [id], onDelete: SetNull)
  name              String
  method            String   @default("SCREEN_PRINT")
  priority          Int      @default(0)
  conditions        Json?
  effects           Json?
  printMethod       PrintMethod?
  minQuantity       Int      @default(1)
  maxQuantity       Int?
  basePrice         Float
  colorSurcharge    Float    @default(0)
  perPlacementCost  Float    @default(0)
  quantityBreaklist Json    // [{qty, price}, ...]
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([ruleSetId])
  @@index([productId])
  @@index([storeId])
  @@index([storeId, ruleSetId, active])
}

model PricingRuleSet {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isDefault   Boolean  @default(false)
  active      Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rules       PricingRule[]

  @@unique([storeId, name])
  @@index([storeId, active])
}

model Quote {
  id            String      @id @default(cuid())
  storeId       String
  store         Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  quoteNumber   String
  customerId    String?
  status        QuoteStatus @default(DRAFT)
  customerName  String?
  customerEmail String?
  notes         String?     @db.Text
  subtotal      Float       @default(0)
  total         Float       @default(0)
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  lineItems     QuoteLineItem[]
  convertedOrder Order?        @relation("QuoteConvertedOrder")
  publicTokens  QuotePublicToken[]

  @@unique([storeId, quoteNumber])
  @@index([storeId, status])
}

enum QuoteStatus {
  DRAFT
  SENT
  APPROVED
  DECLINED
  REJECTED
  EXPIRED
  CONVERTED
}

model QuoteLineItem {
  id               String         @id @default(cuid())
  quoteId          String
  quote            Quote          @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  storeId          String
  store            Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId        String
  product          Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variantId        String?
  variant          ProductVariant? @relation("QuoteLineItemVariant", fields: [variantId], references: [id], onDelete: SetNull)
  productVariantId String?
  productVariant   ProductVariant? @relation("QuoteLineItemProductVariant", fields: [productVariantId], references: [id], onDelete: SetNull)
  qty              Json?
  quantity         Int            @default(1)
  decorationMethod String?
  decorationLocations Json?
  decorationInput  Json?
  printSizeTier    String?
  colorCount       Int?
  stitchCount      Int?
  rush             Boolean        @default(false)
  weightOz         Float?
  pricingSnapshot  Json?
  unitPrice        Float
  lineTotal        Float
  pricingBreakdown Json?
  description      String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([quoteId])
  @@index([storeId])
  @@index([productId])
  @@index([variantId])
  @@index([productVariantId])
}

model PricingSnapshot {
  id                String   @id @default(cuid())
  cartItemId        String   @unique
  cartItem          CartItem @relation(fields: [cartItemId], references: [id], onDelete: Cascade)
  basePrice         Float
  colorSurcharge    Float    @default(0)
  quantityDiscount  Float    @default(0)
  totalPrice        Float
  breakdown         Json     // Detailed pricing breakdown
  frozenAt          DateTime @default(now())

  @@index([cartItemId])
}

// ============================================================================
// CART & CHECKOUT
// ============================================================================

model Cart {
  id        String     @id @default(cuid())
  storeId   String?
  store     Store?     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  userId    String?
  sessionId String?
  token     String?    @unique
  status    CartStatus @default(ACTIVE)
  total     Float      @default(0)
  fundraiserCampaignId String?
  fundraiserCampaign   FundraiserCampaign? @relation("CartFundraiserCampaign", fields: [fundraiserCampaignId], references: [id], onDelete: SetNull)
  fundraiserMemberId   String?
  fundraiserMember     FundraiserCampaignMember? @relation(fields: [fundraiserMemberId], references: [id], onDelete: SetNull)
  fundraiserTeamStoreId String?
  fundraiserTeamStore  TeamStore?  @relation(fields: [fundraiserTeamStoreId], references: [id], onDelete: SetNull)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  items     CartItem[]
  checkoutSessions CheckoutSession[]

  @@index([userId])
  @@index([sessionId])
  @@index([storeId])
  @@index([fundraiserCampaignId])
  @@index([fundraiserMemberId])
  @@index([fundraiserTeamStoreId])
}

enum CartStatus {
  ACTIVE
  OPEN
  ABANDONED
  CONVERTED
  EXPIRED
}

model CartItem {
  id                    String           @id @default(cuid())
  storeId               String?
  store                 Store?           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  cartId                String
  cart                  Cart             @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId             String
  product               Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId             String?
  productVariantId      String
  productVariant        ProductVariant   @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  qty                   Json?
  decorationMethod      String?
  decorationLocations   Json?
  designId              String?
  design                Design?          @relation(fields: [designId], references: [id])
  quantity              Int              @default(1)
  mockupUrl             String?
  pricingSnapshot       PricingSnapshot?
  pricingSnapshotData   Json?
  customNotes           String?
  customizationId       String?          @unique
  customizationJson     Json?
  previewFileId         String?
  fundraiserCampaignId  String?
  fundraiserCampaign    FundraiserCampaign? @relation(fields: [fundraiserCampaignId], references: [id], onDelete: SetNull)
  fundraiserMemberId    String?
  fundraiserMember      FundraiserCampaignMember? @relation(fields: [fundraiserMemberId], references: [id], onDelete: SetNull)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([cartId])
  @@index([storeId])
  @@index([productId])
  @@index([productVariantId])
  @@index([designId])
  @@index([customizationId])
  @@index([fundraiserCampaignId])
  @@index([fundraiserMemberId])
}

model CheckoutSession {
  id              String   @id @default(cuid())
  storeId         String
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  status          CheckoutSessionStatus @default(PENDING)
  customerEmail   String
  shippingAddress Json
  billingAddress  Json?
  totals          Json
  paymentProvider String   @default("NONE")
  providerRef     String?
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  token           String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([storeId])
  @@index([cartId])
  @@index([status])
}

enum CheckoutSessionStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}

// ============================================================================
// ORDERS & FULFILLMENT
// ============================================================================

model Order {

  id                  String        @id @default(cuid())
  externalId   String?
  connectionId String?
  storeId             String
  store               Store         @relation(fields: [storeId], references: [id])
  userId              String
  user                User          @relation(fields: [userId], references: [id])
  fulfillmentStoreId  String?
  fulfillmentStore    Store?        @relation("OrderFulfillmentStore", fields: [fulfillmentStoreId], references: [id], onDelete: SetNull)
  orderNumber         String        @unique
  status              OrderStatus   @default(PENDING)
  paymentStatus       PaymentStatus @default(UNPAID)
  fulfillmentStatus   String        @default("pending")
  subtotal            Float         @default(0)
  taxAmount           Float         @default(0)
  shippingCost        Float         @default(0)
  totalAmount         Float
  notes               String?       @db.Text
  sourceQuoteId       String?       @unique
  sourceQuote         Quote?        @relation("QuoteConvertedOrder", fields: [sourceQuoteId], references: [id], onDelete: SetNull)
  
  // Customer Info
  customerEmail       String
  customerName        String
  shippingAddress     Json
  billingAddress      Json?
  
  // Metadata
  metadata            Json?
  publicToken         String?        @unique
  fundraiserCampaignId String?
  fundraiserCampaign   FundraiserCampaign? @relation("OrderFundraiserCampaign", fields: [fundraiserCampaignId], references: [id], onDelete: SetNull)
  fundraiserMemberId   String?
  fundraiserMember     FundraiserCampaignMember? @relation(fields: [fundraiserMemberId], references: [id], onDelete: SetNull)
  fundraiserTeamStoreId String?
  fundraiserTeamStore  TeamStore?     @relation(fields: [fundraiserTeamStoreId], references: [id], onDelete: SetNull)
  fundraiserAmountCents Int            @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  items               OrderItem[]
  payments            Payment[]
  productionJobs      ProductionJob[]
  shipments           Shipment[]
  invoices            Invoice[]
  fileAssets          FileAsset[]
  proofApprovals      ProofApproval[]
  invoicePublicTokens InvoicePublicToken[]
  checkoutSessions    CheckoutSession[]
  teamStoreMeta       TeamStoreOrderMeta[]
  printPackages       PrintPackage[]
  routedOrder         RoutedOrder?
  royaltyLedgerEntries RoyaltyLedgerEntry[]
  fundraiserConsolidationLines FundraiserConsolidationOrderLine[]
  fundraiserPayoutLedgerEntries FundraiserPayoutLedgerEntry[]
  productionBatchItems ProductionBatchItem[]
  // DecoNetwork mapping
  dnOrderMaps DnOrderMap[]

  @@unique([storeId, orderNumber])
  @@index([storeId])
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([publicToken])
  @@index([fulfillmentStoreId])
  @@index([fundraiserCampaignId])
  @@index([fundraiserMemberId])
  @@index([fundraiserTeamStoreId])

  @@unique([connectionId, externalId])

}

model Storefront {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  slug        String
  name        String
  status      String   @default("ACTIVE")
  theme       Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  collections Collection[]
  pages       Page[]
  themeConfigs ThemeConfig[]

  @@unique([storeId, slug])
  @@index([storeId])
}

model Collection {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storefrontId String
  storefront  Storefront @relation(fields: [storefrontId], references: [id], onDelete: Cascade)
  name        String
  slug        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    CollectionProduct[]

  @@unique([storeId, storefrontId, slug])
  @@index([storeId])
  @@index([storefrontId])
}

model CollectionProduct {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  collectionId String
  collection  Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sortOrder   Int      @default(0)

  @@unique([storeId, collectionId, productId])
  @@index([storeId])
  @@index([collectionId])
  @@index([productId])
}

model Page {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storefrontId String
  storefront  Storefront @relation(fields: [storefrontId], references: [id], onDelete: Cascade)
  slug        String
  title       String
  sections    Json?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([storeId, storefrontId, slug])
  @@index([storeId])
  @@index([storefrontId])
}

model TeamStore {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  slug              String
  name              String
  status            String   @default("ACTIVE")
  closeAt           DateTime?
  minOrderQty       Int?
  fundraiserPercent Float?
  groupShipping     Boolean  @default(false)
  theme             Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  rosterEntries     Roster[]
  personalizationFields PersonalizationField[]
  orderMeta         TeamStoreOrderMeta[]
  fundraiserCampaignLinks FundraiserCampaignTeamStore[]
  fundraiserCampaignMembers FundraiserCampaignMember[]
  fundraiserCarts Cart[]
  fundraiserOrders Order[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([status])
}

model Roster {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  teamStoreId String
  teamStore   TeamStore @relation(fields: [teamStoreId], references: [id], onDelete: Cascade)
  name        String
  number      String?
  meta        Json?
  createdAt   DateTime @default(now())

  orderMeta   TeamStoreOrderMeta[]
  fundraiserCampaignMembers FundraiserCampaignMember[]

  @@index([storeId])
  @@index([teamStoreId])
}

model PersonalizationField {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  teamStoreId String
  teamStore   TeamStore @relation(fields: [teamStoreId], references: [id], onDelete: Cascade)
  key         String
  label       String
  type        String
  options     Json?
  required    Boolean  @default(false)

  @@unique([teamStoreId, key])
  @@index([storeId])
  @@index([teamStoreId])
}

model TeamStoreOrderMeta {
  id             String   @id @default(cuid())
  storeId        String
  store          Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  teamStoreId    String
  teamStore      TeamStore @relation(fields: [teamStoreId], references: [id], onDelete: Cascade)
  rosterEntryId  String?
  rosterEntry    Roster?  @relation(fields: [rosterEntryId], references: [id], onDelete: SetNull)
  personalization Json?

  @@index([storeId])
  @@index([orderId])
  @@index([teamStoreId])
}

model InventoryItem {
  id           String   @id @default(cuid())
  storeId      String
  store        Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  variantId    String
  variant      ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouseId  String?
  qtyOnHand    Int      @default(0)
  qtyReserved  Int      @default(0)
  reorderPoint Int?
  reorderQty   Int?
  updatedAt    DateTime @updatedAt

  movements    StockMovement[]

  @@unique([storeId, variantId, warehouseId])
  @@index([storeId])
  @@index([variantId])
}

model StockMovement {
  id           String   @id @default(cuid())
  storeId      String
  store        Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  variantId    String
  variant      ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  inventoryItemId String?
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  type         String
  qty          Int
  refType      String
  refId        String
  note         String?
  createdAt    DateTime @default(now())

  @@index([storeId])
  @@index([variantId])
  @@index([type])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PRODUCTION
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  REFUNDED
  FAILED
}

model OrderItem {
  id                  String   @id @default(cuid())
  orderId             String
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId           String
  product             Product  @relation(fields: [productId], references: [id])
  productVariantId    String
  productVariant      ProductVariant @relation(fields: [productVariantId], references: [id])
  designId            String?
  design              Design?  @relation(fields: [designId], references: [id])
  mockupUrl           String?
  // Immutable snapshots for each line item
  pricingSnapshot     Json?
  mockupPreviewUrl    String?
  exportAssets        Json?
  customizationId     String?  @unique
  customizationJson   Json?
  previewFileId       String?
  quantity            Int
  decorationMethod    String?
  decorationLocations Json?
  decorationInput     Json?
  printSizeTier       String?
  colorCount          Int?
  stitchCount         Int?
  rush                Boolean  @default(false)
  weightOz            Float?
  unitPrice           Float
  totalPrice          Float
  createdAt           DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([designId])
  @@index([customizationId])
}

model ShippingRate {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name              String
  active            Boolean  @default(true)
  minSubtotal       Float?
  maxSubtotal       Float?
  baseCharge        Float    @default(0)
  perItemCharge     Float    @default(0)
  perOzCharge       Float    @default(0)
  rushMultiplier    Float    @default(1.25)
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([storeId, active])
}

model TaxRate {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name              String
  jurisdiction      String?
  active            Boolean  @default(true)
  rate              Float
  appliesShipping   Boolean  @default(true)
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([storeId, active])
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id              String        @id @default(cuid())
  orderId         String
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount          Float
  currency        String        @default("USD")
  paymentMethod   PaymentMethod
  transactionId   String?       @unique
  status          PaymentStatus @default(PENDING)
  error           String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([orderId])
  @@index([transactionId])
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
  COD
}

model PaymentConfig {
  id              String   @id @default(cuid())
  storeId         String   @unique
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  stripePublicKey String?
  stripeSecretKey String?
  paypalClientId  String?
  paypalSecret    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([storeId])
}

// ============================================================================
// PRODUCTION & FULFILLMENT
// ============================================================================

model ProductionJob {
  id              String          @id @default(cuid())
  orderId         String
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  jobNumber       String          @unique
  status          ProductionStatus @default(QUEUED)
  priority        Priority        @default(NORMAL)
  assignedToId    String?
  artworkUrl      String?
  mockupUrl       String?
  printMethod     PrintMethod?
  notes           String?         @db.Text
  workOrderFileId String?
  workOrderUrl    String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  steps           ProductionStep[]
  shipments       Shipment[]
  fileAssets      FileAsset[]
  printPackages   PrintPackage[]

  @@unique([orderId])
  @@index([orderId])
  @@index([status])
  @@index([priority])
}

model PrintPackage {
  id              String   @id @default(cuid())
  storeId         String
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  productionJobId String?
  productionJob   ProductionJob? @relation(fields: [productionJobId], references: [id], onDelete: SetNull)
  customizationId String?
  customization   Customization? @relation(fields: [customizationId], references: [id], onDelete: SetNull)
  fileId          String
  file            FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([storeId])
  @@index([orderId])
  @@index([productionJobId])
  @@index([customizationId])
}

enum ProductionStatus {
  QUEUED
  ARTWORK_REVIEW
  IN_PRODUCTION
  QUALITY_CHECK
  READY_TO_PACK
  PACKED
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model ProductionStep {
  id              String   @id @default(cuid())
  jobId           String
  job             ProductionJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  step            String   // "artwork_review", "setup", "production", "qc", "packing"
  status          StepStatus @default(PENDING)
  completedBy     String?
  notes           String?  @db.Text
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([jobId])
}

enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
  SKIPPED
}

model ProofApproval {
  id              String              @id @default(cuid())
  storeId         String
  store           Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orderId         String
  order           Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  designId        String?
  design          Design?             @relation(fields: [designId], references: [id], onDelete: SetNull)
  mockupId        String?
  mockup          Mockup?             @relation(fields: [mockupId], references: [id], onDelete: SetNull)
  token           String              @unique
  status          ProofApprovalStatus @default(PENDING)
  recipientEmail  String?
  message         String?
  expiresAt       DateTime?
  requestedById   String?
  requestedBy     User?               @relation("ProofRequestedBy", fields: [requestedById], references: [id], onDelete: SetNull)
  respondedAt     DateTime?
  responseComment String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  events          ProofApprovalEvent[]

  @@index([storeId, status])
  @@index([orderId])
  @@index([token])
}

model ProofApprovalEvent {
  id         String         @id @default(cuid())
  approvalId String
  approval   ProofApproval  @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  storeId    String
  store      Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  actorType  ProofActorType
  actorId    String?
  actor      User?          @relation(fields: [actorId], references: [id], onDelete: SetNull)
  eventType  String
  payload    Json?
  createdAt  DateTime       @default(now())

  @@index([approvalId])
  @@index([storeId])
  @@index([eventType])
}

enum ProofApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum ProofActorType {
  SYSTEM
  ADMIN
  CUSTOMER
}

model Shipment {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productionJobId String
  productionJob   ProductionJob @relation(fields: [productionJobId], references: [id])
  trackingNumber  String?  @unique
  carrier         String?
  weight          Float?
  cost            Float?
  status          String   @default("pending")
  shippedAt       DateTime?
  deliveredAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orderId])
  @@index([productionJobId])
  @@index([trackingNumber])
}

// ============================================================================
// INVOICES & DOCUMENTS
// ============================================================================

model Invoice {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  invoiceNumber   String   @unique
  pdfUrl          String
  issueDate       DateTime @default(now())
  dueDate         DateTime?
  paidAt          DateTime?
  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([invoiceNumber])
}

// ============================================================================
// NOTIFICATIONS & LOGS
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "order_confirmed", "design_ready", etc.
  title     String
  message   String   @db.Text
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
}

model WebhookLog {
  id        String   @id @default(cuid())
  event     String
  payload   Json
  status    Int?
  response  String?  @db.Text
  createdAt DateTime @default(now())

  @@index([event])
}

model WebhookEndpoint {
  id         String   @id @default(cuid())
  storeId    String
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  url        String
  secret     String
  enabled    Boolean  @default(true)
  eventTypes Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  deliveries WebhookDelivery[]

  @@index([storeId])
  @@index([enabled])
}

model WebhookDelivery {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  webhookEndpointId String
  webhookEndpoint   WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)
  eventType         String
  payload           Json
  status            String   @default("QUEUED")
  attempts          Int      @default(0)
  lastError         String?
  nextAttemptAt     DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([storeId])
  @@index([webhookEndpointId])
  @@index([eventType])
  @@index([status])
}

// ============================================================================
// IMPORT JOBS (Vendor CSV Async Processing)
// ============================================================================

model ImportJob {
  id             String   @id @default(cuid())
  vendorId       String
  vendor         Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  storeId        String
  store          Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  status         ImportJobStatus @default(QUEUED)
  sourceFilename String
  totalRows      Int      @default(0)
  processedRows  Int      @default(0)
  createdCount   Int      @default(0)
  updatedCount   Int      @default(0)
  failedRows     Int      @default(0)
  startedAt      DateTime?
  finishedAt     DateTime?
  error          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  errors         ImportJobError[]

  @@index([vendorId])
  @@index([storeId])
  @@index([status])
  @@index([createdAt])
}

enum ImportJobStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
}

model ImportJobError {
  id        String   @id @default(cuid())
  jobId     String
  job       ImportJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  rowNumber Int
  message   String   @db.Text
  rawRow    Json?
  field     String?
  code      String?
  createdAt DateTime @default(now())

  @@index([jobId])
  @@index([rowNumber])
}

// ============================================================================
// DECONETWORK INTEGRATION MODELS
// ============================================================================

model DecoNetworkConnection {
  id                String   @id @default(cuid())
  storeId           String?  // link to Store for tenant scoping
  tenantId          String?  // optional multi-tenant id
  name              String
  baseUrl           String
  encryptedUsername String
  encryptedPassword String
  enabled           Boolean  @default(true)
  lastSyncAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  store Store? @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // DecoNetwork relations
  syncCursors SyncCursor[]
  snapshots IntegrationPayloadSnapshot[]
  syncRuns SyncRun[]
  syncErrors SyncError[]
  dnProductMaps DnProductMap[]
  dnVariantMaps DnVariantMap[]
  dnInventoryMaps DnInventoryMap[]
  dnOrderMaps DnOrderMap[]
  dnPurchaseOrderMaps DnPurchaseOrderMap[]
  inventoryEvents InventoryEvent[]

  @@index([storeId])
  @@index([tenantId])
}

model SyncCursor {
  id           String   @id @default(cuid())
  connectionId String
  entityType   String
  cursorJson   Json?
  updatedAt    DateTime @updatedAt

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, entityType])
}

model IntegrationPayloadSnapshot {
  id           String   @id @default(cuid())
  connectionId String
  entityType   String
  externalId   String?
  payload      Json
  fetchedAt    DateTime @default(now())
  hash         String

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, entityType, externalId, hash])
  @@index([connectionId, entityType])
}

model SyncRun {
  id           String   @id @default(cuid())
  connectionId String
  runType      String   // bootstrap|incremental|backfill
  status       String   @default("PENDING")
  startedAt    DateTime @default(now())
  finishedAt   DateTime?
  statsJson    Json?
  errorCount   Int      @default(0)

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  errors     SyncError[]
  @@index([connectionId])
}

model SyncError {
  id           String   @id @default(cuid())
  runId        String?
  connectionId String
  entityType   String?
  externalId   String?
  message      String   @db.Text
  stack        String?
  payloadHash  String?
  createdAt    DateTime @default(now())

  run SyncRun? @relation(fields: [runId], references: [id], onDelete: Cascade)
  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  @@index([connectionId])
  @@index([runId])
}

// Mapping tables between DN external IDs and canonical domain models
model DnProductMap {
  id         String  @id @default(cuid())
  connectionId String
  productId  String
  externalId String
  rawJson    Json
  createdAt  DateTime @default(now())

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([productId])
}

model DnVariantMap {
  id           String   @id @default(cuid())
  connectionId String
  variantId    String
  externalId   String
  rawJson      Json
  createdAt    DateTime @default(now())

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([variantId])
}

model DnInventoryMap {
  id           String   @id @default(cuid())
  connectionId String
  variantId    String
  externalId   String
  rawJson      Json
  createdAt    DateTime @default(now())

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([variantId])
}
// Inventory events persisted by sync
model InventoryEvent {
  id           String   @id @default(cuid())
  storeId      String
  connectionId String?
  externalId   String?  // DN event id
  type         String
  occurredAt   DateTime
  productId    String?
  variantId    String?
  sku          String?
  locationCode String?
  deltaQty     Int?
  resultingQty Int?
  reference    String?
  rawJson      Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productVariant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  connection DecoNetworkConnection? @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  dnInventoryEventMaps DnInventoryEventMap[]

  @@index([storeId, occurredAt])
  @@index([storeId, variantId, occurredAt])
}

model DnInventoryEventMap {
  id                 String   @id @default(cuid())
  storeId            String
  dnInventoryEventId String
  inventoryEventId   String   @unique
  payloadHash        String?
  rawJson            Json
  createdAt          DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  inventoryEvent InventoryEvent @relation(fields: [inventoryEventId], references: [id], onDelete: Cascade)

  @@unique([storeId, dnInventoryEventId])
  @@index([inventoryEventId])
}
 

model DnOrderMap {
  id           String @id @default(cuid())
  connectionId String
  orderId      String
  externalId   String
  rawJson      Json
  createdAt    DateTime @default(now())

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([orderId])
}

model PurchaseOrder {

  id        String   @id @default(cuid())
  externalId   String?
  connectionId String?
  storeId   String?
  store     Store?   @relation(fields: [storeId], references: [id], onDelete: SetNull)
  vendorId  String?
  supplierName String?
  status    String?  @default("DRAFT")
  expectedAt DateTime?
  total     Float?   @default(0)
  rawJson   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // DecoNetwork mapping
  dnPurchaseOrderMaps DnPurchaseOrderMap[]
  lines PurchaseOrderLine[]

  @@index([storeId])
  @@index([vendorId])

  @@unique([connectionId, externalId])

}

model PurchaseOrderLine {
  id              String   @id @default(cuid())
  storeId         String
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  variantId       String
  variant         ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  qtyOrdered      Int
  qtyReceived     Int      @default(0)
  costEach        Decimal? @db.Decimal(10, 2)
  createdAt       DateTime @default(now())

  @@index([storeId])
  @@index([purchaseOrderId])
  @@index([variantId])
}


model DnPurchaseOrderMap {
  id           String @id @default(cuid())
  connectionId String
  purchaseOrderId String
  externalId   String
  rawJson      Json
  createdAt    DateTime @default(now())

  connection DecoNetworkConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([purchaseOrderId])
}


